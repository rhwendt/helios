apiVersion: "clickhouse.altinity.com/v1"
kind: "ClickHouseInstallation"
metadata:
  name: {{ include "helios.fullname" . }}-clickhouse
  namespace: helios-flows
  labels:
    {{- include "helios.labels" . | nindent 4 }}
    app.kubernetes.io/component: clickhouse
spec:
  configuration:
    clusters:
      - name: helios-flows
        layout:
          shardsCount: {{ .Values.clickhouse.shards | default 2 }}
          replicasCount: {{ .Values.clickhouse.replicas | default 2 }}
    zookeeper:
      nodes:
        - host: {{ include "helios.fullname" . }}-kafka-zookeeper-client.helios-flows.svc.cluster.local
          port: 2181
    settings:
      max_concurrent_queries: 100
      max_memory_usage: 10000000000
    profiles:
      default/max_memory_usage: 10000000000
      default/max_execution_time: 300
    users:
      default/networks/ip:
        - "10.0.0.0/8"
        - "172.16.0.0/12"
        - "192.168.0.0/16"
  defaults:
    templates:
      dataVolumeClaimTemplate: data-volume
      logVolumeClaimTemplate: log-volume
  templates:
    volumeClaimTemplates:
      - name: data-volume
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: {{ .Values.clickhouse.storage | default "100Gi" }}
      - name: log-volume
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi
